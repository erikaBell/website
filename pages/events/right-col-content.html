<h2 class="event-title">
    <img class="vector-img" src="../assets/images/hack-nights/meetings.svg" alt="image of a group of people" />
    Online Project Team Meetings
</h2>
<div class="mobile-dropdown">
    <div class="meetup-steps-2">
        <div id="img-content">
            <img class="step-img-2" src="../assets/images/hack-nights/org-projects.png" />
        </div>
        <div id="text-content-1">
            <p>
                Please review the listing of project team meeting times to find a
                project that fits your schedule. You are welcome to attend a project
                team meeting after you have completed
                <a href="https://www.hackforla.org/getting-started" target="_blank">Onboarding</a>.
            </p>
        </div>
    </div>
    <div class="days-display-1">
        <div id="userTimeZone" class="userTimeZone"></div>
        {% assign days-of-week =
        "Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday" | split: "," %}
        {% for day in days-of-week %}
        <div id="{{day}}">
            <h3 class="day-header-1">{{day}}</h3>
            <ul id="{{day}}-List" class="schedule-list-1"></ul>
        </div>
        {% endfor %}
    </div>
</div>
<script>

    const API_ENDPOINT = 'https://www.vrms.io/api/recurringevents';

    // const API_ENDPOINT = 'https://api.jsonbin.io/b/60735df15b165e19f61d0d9d/3'

    let req = new XMLHttpRequest('https://api.jsonbin.io/b/60735df15b165e19f61d0d9d/3');

        req.onreadystatechange = () => {
            if (req.readyState == XMLHttpRequest.DONE) {
                const parseData = JSON.parse(req.response);
                console.log(parseData.map(dates => console.log(dates.updatedDate)))
                // console.log(req.responseText);
            }
        };

        req.open("GET", "https://api.jsonbin.io/b/60735df15b165e19f61d0d9d", true);
        req.setRequestHeader("secret-key", `$2b$10$5hcb.eTuJFK.70MfEDUTeOvS9BoKt3fDBeMAdGIXAN/Lf.2QepRIG`);
        req.send();

    /**
     * This type of function is called an IIFE function. The main function is the primarily controller that loads the recurring events on this page.
     * Refer: https://developer.mozilla.org/en-US/docs/Glossary/IIFE
    */
    (async function main(){

//Retrieves storedData and then checks: API updatedDate > users storedDate ?
        if(localStorage.getItem('storedDate')) {
            const storedData = JSON.parse(localStorage.getItem('storedData'))
            document.addEventListener('DOMContentLoaded', insertEventSchedule(storedData))
    //do i need to write the response_data const twice? 
            const response_data = await sendGetRequest(API_ENDPOINT);
            compareDates(response_data)
            return
        }

//Initial fetch and store of data, if does not already exist in users localStorage
        const response_data = await sendGetRequest(API_ENDPOINT);
        filterSortInsert(response_data)
        // let filteredData = filterDataFromApi(response_data);
        // compareDates(response_data)

        // let sortedData = sortData(filteredData);

        // document.addEventListener('DOMContentLoaded',insertEventSchedule(sortedData));
        
        // //Displays/Inserts the user's time zone in the DOM
        // document.querySelector('#userTimeZone').insertAdjacentHTML('afterbegin', timeZoneText());

        // storeData(sortedData)
    })()

//TODO: to be used in different context / different 
//TODO: create Prototypes of functions used more than once 
    function filterSortInsert(responseData){
        let filteredData = filterDataFromApi(responseData);
        compareDates(responseData)

        let sortedData = sortData(filteredData);

        document.addEventListener('DOMContentLoaded', insertEventSchedule(sortedData));

        //Displays/Inserts the user's time zone in the DOM
        document.querySelector('#userTimeZone').insertAdjacentHTML('afterbegin', timeZoneText());

        storeData(sortedData)
    }


//TODO: 
     function storeData(apiData){
        const dataString = JSON.stringify(apiData)
        const date = Date()
        const userDate = new Date().toISOString(date)

        if (!localStorage.getItem('storedData')) {
             localStorage.setItem('storedData', `${dataString}`)
         }

        if(!localStorage.getItem('storedDate')){
            localStorage.setItem('storedDate', `${userDate}`)
        } 
    }

//TODO: 
//** Need to Change this to my own API fetch .. 
//** As the current one _will not fetch_ if user has localStorage of date-time
    function compareDates(responseData){
        let updatedDates = responseData.map(data => (data.updatedDate))
        const userDate = localStorage.getItem('storedDate')

        for(const date of updatedDates){
            if(date > userDate){
                // filterSortInsert(responseData)
            } else {
                console.log('No needed Update')
            }
        }
    }

    /**
     * Retrieves data from the wins excel sheet provided a valid excel url
     * @param  {URL} url 
     * @return {Object} response data
     */
     async function sendGetRequest(url){
        try {
            // const resp =  await axios.get(url);
            const resp = await fetch(url);
            return await resp.json();
        } catch (err) {
            // Handle Error Here
            console.error(err);
        }
    }
 
    /**
     * Filters out the needed data from the api endpoint
    */
    function filterDataFromApi(response_data){
        const return_obj={}
        response_data.forEach(item=>{
            let day_of_week = getDayString(item.date)
            if(!(day_of_week in return_obj)){
                return_obj[day_of_week] = [];
                return_obj[day_of_week].push(display_object(item))
            }
            else{
                return_obj[day_of_week].push(display_object(item))
            }
        })

        return return_obj;
    }

    /**
     * Sorts Filtered Date from the api end point by their start time
    */
    function sortData(filteredData){
        for(const [key,value] of Object.entries(filteredData)){
            value.sort(function (a, b) {
                return convertTime12to24(a.start) - convertTime12to24(b.start);
            });
        }
        return filteredData;
    }

    /**
     * Inserts the recurring events into the html
     * @param {Object} sortedData - An array object of the type returned by displayObject()
    */
    function insertEventSchedule(sortedData){
        for(const [key,value] of Object.entries(sortedData)){
            let placeToInsert = document.querySelector(`#${key}-List`);
            value.forEach(event=>{
                placeToInsert.insertAdjacentHTML('beforeend',
                `<li>${event.start} - ${event.end} </li><li><a href="${event.hflaWebsiteUrl}">${event.name}</a> ${event.dsc}</li>`
                );
            })
        }

    }


    /**
     * @param {Date} time - A valid javscript time string. Example:  "2020-05-13T02:00:00.000Z"
     * @return {String} - A time string formatted in the 12 hour format and converted to your timezone. Example: "10:00 PM"
    */
    function localeTimeIn12Format(time){
        return new Date(time)
            .toLocaleTimeString(
                {},
                {timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,hour12:true,hour:'2-digit',minute:'numeric'}
            );
        
    }

    /**
     * @param {Date} date - A valid javscript time string. Example:  "2020-05-13T02:00:00.000Z"
     * @return {String} - The name of the day represented by the time string. Example 2020-05-13 was a wednesday. I.e rv = 'Wednesday'
    */
    function getDayString(date){
        let new_date = new Date(date);
        let weekday = new_date.getDay();
        let options = {weekday:'long'};
        return new Intl.DateTimeFormat('en-US', options).format(new_date);
    }

    /**
     * Given a time string of 12 hour format like '06:00 pm' returns the integer of that string in 24 hour format -> 0600
     * @param {String} time12h - A 12 hour format time string
     * @return {Integer} An integer representing the input time string in 24 hour format
    */
    function convertTime12to24(time12h){
        const [time, modifier] = time12h.split(" ");
        
        let [hours, minutes] = time.split(":");
        
        if (hours === "12") {
            hours = "00";
        }
        
        if (modifier.toLowerCase() === 'pm') {
            hours = parseInt(hours, 10) + 12;
        }
        return parseInt(`${hours}${minutes}`);

    }

    /**
     * Function that represent the individual object extracted from the api
    */
    function display_object(item){
        rv_object = {
            "name":item.project.name,
            "dsc": item.description,
            "start":localeTimeIn12Format(item.startTime),
            "end": localeTimeIn12Format(item.endTime),
            "hflaWebsiteUrl": item.project.hflaWebsiteUrl
        }
        return rv_object;
    }


</script>